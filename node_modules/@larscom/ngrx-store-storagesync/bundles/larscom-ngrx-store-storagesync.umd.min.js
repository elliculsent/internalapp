!function(r,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("lodash-es"),require("@angular/core"),require("@ngrx/store"),require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("@larscom/ngrx-store-storagesync",["exports","lodash-es","@angular/core","@ngrx/store","rxjs","rxjs/operators"],e):e(((r=r||self).larscom=r.larscom||{},r.larscom["ngrx-store-storagesync"]={}),r.lodashEs,r.ng.core,r.store,r.rxjs,r.rxjs.operators)}(this,(function(r,e,t,n,o,i){"use strict";var s="@ngrx/store/init",c="@ngrx/effects/init",a="@ngrx/store/update-reducers",u=/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/;Object.create;function f(r,e){var t="function"==typeof Symbol&&r[Symbol.iterator];if(!t)return r;var n,o,i=t.call(r),s=[];try{for(;(void 0===e||e-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(r){o={error:r}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(o)throw o.error}}return s}Object.create;var l=function(r,e){if(!e)return r;var t=e.map((function(r){return{rootKey:r.split(".")[0],nestedKey:r.split(".")[1]}})),n=function(n){if(r.hasOwnProperty(n)){var o=t.find((function(r){return r.rootKey===n})),i=o?o.rootKey:null,s=o?o.nestedKey:null;switch(typeof r[n]){case"object":i&&!r[n]?delete r[n]:i&&s?l(r[n],function(){for(var r=[],e=0;e<arguments.length;e++)r=r.concat(f(arguments[e]));return r}(e,[s])):i?delete r[n]:l(r[n],e);break;default:i&&delete r[n]}}};for(var o in r)n(o);return r},p=function(r){for(var t in r)e.isPlainObject(r[t])&&(p(r[t]),Object.keys(r[t]).length||delete r[t]);return r},y=new t.InjectionToken("FORM_SYNC_CONFIG",{factory:function(){return{syncOnSubmit:!1,syncRawValue:!1,syncValidOnly:!1}}}),d=new t.InjectionToken("FORM_SYNC_REDUCER"),g=n.createAction("@larscom/form-sync/set",n.props()),m=n.createAction("@larscom/form-sync/patch",n.props()),h=n.createAction("@larscom/form-sync/reset",n.props()),v=n.createAction("@larscom/form-sync/delete",n.props()),b=n.createFeatureSelector("formSync"),S=n.createSelector(b,(function(r,e){return r[e.id]})),O=function(){function r(r,e){this.config=r,this.store=e,this.formGroupSync=!0,this.subscriptions=new o.Subscription}return r.prototype.ngOnInit=function(){var r=this;if(this.formGroupId){var e=this.config,t=e.syncOnSubmit,o=e.syncValidOnly,s=e.syncRawValue;this.subscriptions.add(this.formGroup.valueChanges.pipe(i.filter((function(){return r.formGroupSync})),i.filter((function(){return!(o&&!r.formGroup.valid)})),i.filter((function(){return!t}))).subscribe((function(){return r.dispatch(s)}))),this.subscriptions.add(this.store.pipe(i.filter((function(){return r.formGroupSync})),n.select(S,{id:this.formGroupId}),i.filter((function(r){return null!=r}))).subscribe((function(e){return r.formGroup.patchValue(e,{emitEvent:!1})})))}},r.prototype.ngOnDestroy=function(){this.subscriptions.unsubscribe()},r.prototype.onSubmit=function(){if(this.formGroupId&&this.formGroupSync){var r=this.config,e=r.syncOnSubmit,t=r.syncValidOnly,n=r.syncRawValue;e&&(t&&!this.formGroup.valid||this.dispatch(n))}},r.prototype.dispatch=function(r){var e=r?this.formGroup.getRawValue():this.formGroup.value;this.store.dispatch(m({id:this.formGroupId,value:e}))},r}();O.decorators=[{type:t.Directive,args:[{selector:"[formGroup]"}]}],O.ctorParameters=function(){return[{type:void 0,decorators:[{type:t.Inject,args:[y]}]},{type:n.Store}]},O.propDecorators={formGroup:[{type:t.Input}],formGroupId:[{type:t.Input}],formGroupSync:[{type:t.Input}],onSubmit:[{type:t.HostListener,args:["submit"]}]};var j=n.createReducer(Object(),n.on(g,(function(r,e){var t,n=e.id,o=e.value;return Object.assign(Object.assign({},r),((t={})[n]=o,t))})),n.on(m,(function(r,t){var n,o=t.id,i=t.value;return e.merge({},Object.assign({},r),((n={})[o]=i,n))})),n.on(h,(function(r,t){var n,o=t.id,i=function(r){for(var t in r)r.hasOwnProperty(t)&&(e.isPlainObject(r[t])?i(r[t]):e.isArray(r[t])?Array(r[t]).forEach((function(r){return i(r)})):r[t]=null);return r},s=i(e.cloneDeep(r[o]));return Object.assign(Object.assign({},r),((n={})[o]=s,n))})),n.on(v,(function(r,e){var t,n=e.id;return Object.assign(Object.assign({},r),((t={})[n]=void 0,t))}))),F=function(){function r(){}return r.forRoot=function(){return{ngModule:r,providers:[{provide:d,useValue:j}]}},r}();F.decorators=[{type:t.NgModule,args:[{declarations:[O],imports:[n.StoreModule.forFeature("formSync",d)],exports:[O]}]}],r.FORM_SYNC_CONFIG=y,r.FORM_SYNC_REDUCER=d,r.FORM_SYNC_STORE_KEY="formSync",r.FormGroupDirective=O,r.FormSyncModule=F,r.deleteForm=v,r.formSyncReducer=j,r.getFormSyncValue=S,r.patchForm=m,r.resetForm=h,r.setForm=g,r.storageSync=function(r){return function(t){var n=Object.assign({rehydrate:!0,storageKeySerializer:function(r){return r},rehydrateStateMerger:function(r,t){return e.merge({},r,t)}},r),o=n.rehydrate,i=n.rehydrateStateMerger,f=o?function(r){var e=r.storage,t=r.storageKeySerializer,n=r.features,o=r.storageError,i=r.version;if(i)try{var s=t("version");if(+e.getItem(s)<i)return null}catch(r){if(!o)throw r;o(r)}var c=n.reduce((function(r,n){var i,s=n.storageKeySerializerForFeature,c=n.stateKey,a=n.deserialize,f=n.storageForFeature,l=s?s(c):t(c);try{var p=f?f.getItem(l):e.getItem(l);return p?Object.assign(Object.assign({},r),((i={})[c]=a?a(p):JSON.parse(p,(function(r,e){return u.test(String(e))?new Date(e):e})),i)):r}catch(r){if(!o)throw r;o(r)}}),{});return Object.keys(c).length?c:null}(n):null;return function(r,o){var u=o.type===s?t(r,o):Object.assign({},r),y=f&&[s,a].includes(o.type),d=t(y?i(u,f):u,o);return[s,c].includes(o.type)?d:function(r,t){var n=t.features,o=t.storage,i=t.storageKeySerializer,s=t.storageError,c=t.version;if(c)try{var a=i("version");o.setItem(a,String(c))}catch(r){if(!s)throw r;s(r)}return n.filter((function(e){var t=e.stateKey;return void 0!==r[t]})).filter((function(e){var t=e.stateKey,n=e.shouldSync;return!n||n(r[t],r)})).forEach((function(t){var n=t.stateKey,c=t.excludeKeys,a=t.storageKeySerializerForFeature,u=t.serialize,f=t.storageForFeature,y=e.cloneDeep(r[n]),d=p(l(y,c));if(!e.isPlainObject(d)||Object.keys(d).length){var g=a?a(n):i(n),m=u?u(d):JSON.stringify(d);try{f?f.setItem(g,m):o.setItem(g,m)}catch(r){if(!s)throw r;s(r)}}})),r}(d,n)}}},r.Éµa=b,Object.defineProperty(r,"__esModule",{value:!0})}));
//# sourceMappingURL=larscom-ngrx-store-storagesync.umd.min.js.map